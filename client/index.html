<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Title</title>
  </head>
  <body>
    <div class="container">
      <div class="content">
        <div id="chat"></div>
        <form id="messageForm">
          <input
            type="text"
            name="message"
            id="message"
            placeholder="message"
            maxlength="50"
          />
          <input type="submit" value="send" />
        </form>
      </div>
    </div>

    <script type="module">
      const chatEl = document.getElementById("chat");
      const ws = new WebSocket("ws://127.0.0.1:8000");
      const name = Date.now();

      ws.onmessage = (message) => {
        const messages = JSON.parse(message.data);
        messages.forEach((val) => {
          const messageEl = document.createElement("div");
          messageEl.appendChild(
            document.createTextNode(`${val.name}: ${val.message}`)
          );
          chat.appendChild(messageEl);
        });
      };

      let debounceTimeout;
      const DEBOUNCE_DELAY = 500;

      const send = (event) => {
        event.preventDefault();

        if (debounceTimeout) {
          return;
        }

        const message = document.getElementById("message").value.trim();
        if (message === "") return;

        ws.send(
          JSON.stringify({
            name,
            message,
          })
        );

        document.getElementById("message").value = "";

        debounceTimeout = setTimeout(() => {
          debounceTimeout = null;
        }, DEBOUNCE_DELAY);
      };

      const formEl = document.getElementById("messageForm");
      formEl.addEventListener("submit", send);
    </script>
  </body>
</html>
